[{"name":"app.R","content":"library(shiny)\r\nlibrary(shinyRadioMatrix)\r\nlibrary(shinycssloaders)\r\nlibrary(googlesheets4)\r\nlibrary(stringr)\r\n\r\n# setwd(r\"(C:\\Users\\student\\Documents\\GitHub\\wedding-site-rsvp\\rsvp)\")\r\n# \r\n# options(gargle_oauth_cache = \".secrets\")\r\n# gs4_auth()\r\n# list.files(\".secrets\")\r\n# gs4_deauth()\r\ngs4_auth(cache=\".secrets\", email=\"aaronweinstock22@gmail.com\")\r\n\r\n# options(\r\n#   # whenever there is one account token found, use the cached token\r\n#   gargle_oauth_email = TRUE,\r\n#   # specify auth tokens should be stored in a hidden directory \".secrets\"\r\n#   gargle_oauth_cache = \".secrets\"\r\n# )\r\n\r\n# Data =========================================================================\r\n\r\n# Globals\r\nSHEET_ID = \"1a2uoCM9fMm5gDgv-BLgsrVhcVeIGhAMNivF0OzQLIT8\"\r\nSHEET_NAME = \"RSVP\"\r\nATTENDING_COL = \"D\"\r\nVEGETARIAN_COL = \"E\"\r\n\r\n# Build invites list: names are passwords, each contains a household name\r\n# and a list of guests\r\nrsvp = read_sheet(\r\n  ss = SHEET_ID,\r\n  sheet = SHEET_NAME\r\n)\r\npasswords = unique(rsvp$Password)\r\npasswords = passwords[passwords != \"sepwhat\"]\r\nINVITES = lapply(passwords, function(p){\r\n  list(\r\n    household = rsvp$Household[rsvp$Password == p][1],\r\n    people = rsvp$Guest[rsvp$Password == p]\r\n  )\r\n})\r\nnames(INVITES) = passwords\r\n\r\n# UI ===========================================================================\r\n\r\nui = fluidPage(\r\n  # Title\r\n  titlePanel(\r\n    \"Wedding RSVP\"\r\n  ),\r\n  # Password input\r\n  fluidRow(\r\n    div(\r\n      h4(\r\n        strong(\r\n          \"Please enter the password on your RSVP and click 'Go!'\"  \r\n        )\r\n      ),\r\n      style = \"display:inline-block;vertical-align:center;margin-left:15px;margin-right:5px\"\r\n    ),\r\n    div(\r\n      textInput(\r\n        inputId = \"PASSWORD\",\r\n        label = NULL,\r\n        value = \"\",\r\n        width = \"100%\"\r\n      ),\r\n      style = \"display:inline-block;vertical-align:center;margin:5px\"\r\n    ),\r\n    div(\r\n      actionButton(\r\n        inputId = \"GO\",\r\n        label = \"Go!\"\r\n      ),\r\n      style = \"display:inline-block;vertical-align:center;margin:5px\"\r\n    )\r\n  ),\r\n  # RSVP submission\r\n  fluidRow(\r\n    column(\r\n      12,\r\n      uiOutput(\r\n        outputId = \"INTRO\"\r\n      )\r\n    ),\r\n    column(\r\n      12,\r\n      uiOutput(\r\n        outputId = \"BUTTONS\"\r\n      )\r\n    ),\r\n    # column(\r\n    #   12,\r\n    #   uiOutput(\r\n    #     outputId = \"SUBMIT_RSVP\"\r\n    #   ),\r\n    # ),\r\n    column(\r\n      12,\r\n      fluidRow(\r\n        div(\r\n          uiOutput(\r\n            outputId = \"SUBMIT_RSVP\"\r\n          ),\r\n          style = \"display:inline-block;vertical-align:center;margin-left:15px;margin-right:5px\"\r\n        ),\r\n        div(\r\n          uiOutput(\r\n            outputId = \"SUBMIT_INSTRUCTIONS\"\r\n          ),\r\n          style = \"display:inline-block;vertical-align:center;margin:5px\"\r\n        )\r\n      )\r\n    ),\r\n    column(\r\n      12,\r\n      uiOutput(\r\n        outputId = \"PASSWORD_ERROR\"\r\n      )\r\n    ),\r\n    column(\r\n      12,\r\n      uiOutput(\r\n        outputId = \"SUBMISSION\"\r\n      )  \r\n    )\r\n  )\r\n)\r\n\r\n# Server =======================================================================\r\n\r\nserver = function(input, output){\r\n  # Response to password input\r\n  observeEvent(input$GO, {\r\n    if(input$PASSWORD %in% names(INVITES)){\r\n      people = INVITES[[input$PASSWORD]]$people\r\n      n = length(people)\r\n      output$INTRO = renderUI({\r\n        paste0(\r\n          \"Hi \", INVITES[[input$PASSWORD]]$household, \"! Thanks for RSVPing! \",\r\n          \"Please read the instructions and respond accordingly.\",\r\n          \"<br><br>\",\r\n          \"Please select 'No' for all members of your party who will not be \",\r\n          \"attending -- we will miss you!\",\r\n          \"<br><br>\",\r\n          \"For those who will be attending, the main course for our wedding \",\r\n          \"will be buffet-style Texas barbecue, with options of pulled pork, pork ribs, \",\r\n          \"and/or beef brisket. We will have to order the vegetarian option \",\r\n          \"(barbecue-style cauliflower) separately. \",\r\n          \"If any attending member of your party will eat NONE of the three \",\r\n          \"meat options, please select 'Yes - vegetarian'. Only select this \",\r\n          \"option if you will eat no meat. For those attending who will eat \",\r\n          \"at least one of the meats, select 'Yes - meat'. This is crucial \",\r\n          \"to ensure we order the right amount of the vegetarian \",\r\n          \"option, and we appreciate your attention to this detail!\",\r\n          \"<br><br>\"\r\n        ) %>%\r\n          HTML()\r\n      })\r\n      output$BUTTONS = renderUI({\r\n        shinyRadioMatrix::radioMatrixInput(\r\n          inputId = \"RSVP\",\r\n          rowIDs = people,\r\n          rowLLabels = rep(\"\", n),\r\n          choiceNames = list(\"Yes! - meat\",\"Yes! - vegetarian\",\"No :(\"),\r\n          choiceValues = list(\"YES\",\"YESV\",\"NO\"),\r\n          selected = rep(list(character(0)), n),\r\n          rowIDsName = \"Guest\"\r\n        )\r\n      })\r\n      output$SUBMIT_RSVP = renderUI({\r\n        actionButton(\r\n          inputId = \"SUBMIT\",\r\n          label = \"Submit your RSVP\"\r\n        )\r\n      })\r\n      output$SUBMIT_INSTRUCTIONS = renderUI({\r\n        h5(\r\n          paste(\r\n            \"Please click Submit only once per submission. \",\r\n            \"A message will appear to confirm the RSVP is recorded; \",\r\n            \"don't close the page until you see this message.\"\r\n          )\r\n        )\r\n      })\r\n      output$PASSWORD_ERROR = renderUI({\r\n        NULL\r\n      })\r\n    } else{\r\n      output$INTRO = renderUI({\r\n        NULL\r\n      })\r\n      output$BUTTONS = renderUI({\r\n        NULL\r\n      })\r\n      output$SUBMIT_RSVP = renderUI({\r\n        NULL\r\n      })\r\n      output$PASSWORD_ERROR = renderUI({\r\n        h5(\r\n          strong(\r\n            paste(\r\n              \"Your entry doesn't match a password given to any household :( \",\r\n              \"Please try again, and remember that these passwords are case sensitive.\",\r\n              \"If there are continued issues, get in touch with Aaron or Steph.\"\r\n            )\r\n          ),\r\n          style = \"color:red\"\r\n        )\r\n      })\r\n    }\r\n  })\r\n  # Response to submission\r\n  observeEvent(input$SUBMIT, {\r\n    missing = sum(\r\n      unlist(\r\n        lapply(input$RSVP, function(name){\r\n          is.null(name)\r\n        })\r\n      )\r\n    )\r\n    if(missing > 0){\r\n      output$SUBMISSION = renderUI({\r\n        h5(\r\n          strong(\r\n            paste(\r\n              \"RSVP was not made for at least one guest in the household;\",\r\n              \"please ensure all guests are accounted for and resubmit.\"\r\n            ) \r\n          ),\r\n          style = \"color:red\"\r\n        )\r\n      })  \r\n    } else{\r\n      for(name in names(input$RSVP)){\r\n        sheet_range = paste0(\r\n          c(ATTENDING_COL, VEGETARIAN_COL),\r\n          which(rsvp$Guest == name)+1\r\n        ) %>%\r\n          paste(collapse=\":\")\r\n        if(str_detect(input$RSVP[[name]], \"^YES\")){\r\n          is_attending = \"YES\"\r\n        } else{\r\n          is_attending = \"NO\"\r\n        }\r\n        if(str_detect(input$RSVP[[name]], \"V$\")){\r\n          is_vegetarian = \"YES\"\r\n        } else{\r\n          is_vegetarian = \"NO\"\r\n        }\r\n        new_data = data.frame(\r\n          Attending = is_attending,\r\n          Vegetarian = is_vegetarian\r\n        )\r\n        googlesheets4::range_write(\r\n          ss = SHEET_ID,\r\n          data = new_data,\r\n          sheet = SHEET_NAME,\r\n          range = sheet_range,\r\n          col_names = FALSE,\r\n          reformat = FALSE\r\n        )\r\n      }\r\n      output$SUBMISSION = renderUI({\r\n        h4(\r\n          paste(\r\n            \"Thanks! Your RSVP has been recorded. \",\r\n            \"If anything changes, please re-submit your RSVP as soon as you know.\",\r\n            \"Hopefully we'll be celebrating with you in September, but if not, you'll be missed!\"\r\n          ),\r\n          style = \"color:green\"\r\n        )\r\n      })\r\n    }\r\n  })\r\n}\r\n\r\n# Run ==========================================================================\r\n\r\nshinyApp(ui = ui, server = server)\r\n\r\n","type":"text"}]
